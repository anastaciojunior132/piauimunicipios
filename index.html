<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa – Sidebar e Download KML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .legend {
      background: white;
      line-height: 18px;
      color: #333;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    #downloadBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }
    #uploadBtn {
      position: absolute;
      top: 80px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }
    #uploadInput { display: none; }
    .north-arrow {
      pointer-events: none;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Map_symbol_north_arrow.svg/64px-Map_symbol_north_arrow.svg.png');
      background-size: contain;
      background-repeat: no-repeat;
      width: 40px;
      height: 40px;
      opacity: 0.8;
      margin-right: 10px;
      margin-top: 10px;
    }
    #searchMunicipio {
      position: absolute;
      top: 30px;
      left: 1000px;
      z-index: 3000;
      padding: 5px 20px;
      width: 180px;
      border: 1px solid #ccc;
      border-radius: 40px;
      font-size: 20px;
    }
    #listaMunicipios {
      position: absolute;
      top: 70px;
      left: 1000px;
      z-index: 4000;
      max-height: 200px;
      overflow-y: auto;
      width: 180px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
      font-size: 16px;
    }
    #listaMunicipios div {
      padding: 4px 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #listaMunicipios div:hover { background-color: #ddd; }
    #coords {
      position: absolute;
      bottom: 50px; /* subiu para não ficar na mesma altura da escala */
      left: 10px;
      background: rgba(255, 255, 255, 0.5); /* fundo branco semi-transparente */
      padding: 5px 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid rgba(204, 204, 204, 0.5);
      z-index: 1000;
    }
    .map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-title">Mapa Interativo – Territórios e Municípios</div>
  <div id="coords">Lat: -, Lon: -<br>E: -, N: -<br>Fuso: -</div>

  <button id="uploadBtn">Upload KML</button>
  <input type="file" id="uploadInput" accept=".kml,.kmz,.xml" multiple />
  
  <input type="text" id="searchMunicipio" placeholder="Pesquisar município" />
  <div id="listaMunicipios"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
  <!-- JSZip para ler KMZ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- toGeoJSON para converter KML em GeoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@0.16.0/dist/togeojson.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.js"></script> <!-- Você usa tokml, então inclua -->

  <script>
    const map = L.map('map').setView([-7, -42], 7);
    L.control.scale().addTo(map);

    const north = L.control({position: "topright"});
    north.onAdd = function(map) {
      const div = L.DomUtil.create("div", "north-arrow");
      return div;
    };
    north.addTo(map);

    // Camadas base
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    });

    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    const esriTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    const esriRoad = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    // Define camada padrão (OpenStreetMap)
    osmLayer.addTo(map);

    /* =========================
       SEU CÓDIGO EXISTENTE PARA TERRITÓRIOS, MUNICÍPIOS, ETC...
       ========================= */
    const territorioPalette = [
      '#1f78b4', '#e31a1c', '#33a02c', '#ff7f00',
      '#6a3d9a', '#b15928', '#a6cee3', '#b2df8a',
      '#fb9a99', '#fdbf6f'
    ];

    const territorioColors = [];
    let colorIndex = 0;

    function getColorForTerritorio(nome) {
      let terr = territorioColors.find(t => t.nome === nome);
      if (!terr) {
        terr = { nome, cor: territorioPalette[colorIndex % territorioPalette.length] };
        territorioColors.push(terr);
        colorIndex++;
      }
      return terr.cor;
    }

    function generateInfoContent(properties) {
      let content = "<b>Atributos:</b><br>";
      for (const key in properties) {
        content += `<b>${key}:</b> ${properties[key]}<br>`;
      }
      return content;
    }

    function onEachFeaturePopup(feature, layer) {
      if (feature.properties) {
        const popupContent = generateInfoContent(feature.properties) + 
          `<button class="download-btn" style="margin-top:5px;">Baixar KML desta feição</button>`;
        layer.bindPopup(popupContent);

        layer.on('popupopen', () => {
          const btn = document.querySelector('.download-btn');
          if (btn) {
            btn.onclick = () => {
              const kml = tokml({ type: "FeatureCollection", features: [feature] });
              const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "feicao.kml";
              a.click();
              URL.revokeObjectURL(url);
            };
          }
        });
      }
    }

    function styleTerritorios(feature) {
      const nome = feature.properties.NM_TD || "Território";
      return {
        color: getColorForTerritorio(nome),
        weight: 2,
        fillColor: getColorForTerritorio(nome),
        fillOpacity: 0.4
      };
    }

    const territoriosLayer = new L.GeoJSON.AJAX("territorios.geojson", { 
      style: styleTerritorios,
      onEachFeature: onEachFeaturePopup
    });

    territoriosLayer.on('data:loaded', addLegend);
    territoriosLayer.addTo(map);

    function styleMunicipios() {
      return { color: '#000', weight: 1.5, fillOpacity: 0 };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({ weight: 3, color: '#666', fillOpacity: 0.1 });
      layer.bringToFront();
    }

    function resetHighlight(e) {
      municipiosLayer.resetStyle(e.target);
    }

    function onEachMunicipio(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight
      });
      if (feature.properties) {
        layer.bindPopup(generateInfoContent(feature.properties) +
          `<button class="download-btn" style="margin-top:5px;">Baixar KML desta feição</button>`);
        layer.on('popupopen', () => {
          const btn = document.querySelector('.download-btn');
          if (btn) {
            btn.onclick = () => {
              const kml = tokml({ type: "FeatureCollection", features: [feature] });
              const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "feicao.kml";
              a.click();
              URL.revokeObjectURL(url);
            };
          }
        });
      }
    }

    const municipiosLayer = new L.GeoJSON.AJAX("municipios.geojson", { 
      style: styleMunicipios,
      onEachFeature: onEachMunicipio
    });
    municipiosLayer.addTo(map);

    /* ================== Busca Fuzzy =================== */
    const searchInput = document.getElementById('searchMunicipio');
    const listaMunicipios = document.getElementById('listaMunicipios');

    function levenshtein(a, b) {
      const matrix = [];
      for(let i = 0; i <= b.length; i++){ matrix[i] = [i]; }
      for(let j = 0; j <= a.length; j++){ matrix[0][j] = j; }
      for(let i = 1; i <= b.length; i++){
        for(let j = 1; j <= a.length; j++){
          if(b.charAt(i-1) === a.charAt(j-1)){
            matrix[i][j] = matrix[i-1][j-1];
          } else {
            matrix[i][j] = Math.min(matrix[i-1][j-1] + 1,
              Math.min(matrix[i][j-1] + 1, matrix[i-1][j] +1));
          }
        }
      }
      return matrix[b.length][a.length];
    }

    searchInput.addEventListener('input', function () {
      const termo = this.value.trim().toLowerCase();
      listaMunicipios.innerHTML = '';
      if (!termo) {
        listaMunicipios.style.display = 'none';
        return;
      }

      const resultados = [];

      municipiosLayer.eachLayer(layer => {
        const nomeMun = layer.feature.properties.NM_MUN;
        if (nomeMun) {
          const nomeLower = nomeMun.toLowerCase();
          if (nomeLower.includes(termo)) {
            resultados.push({ nome: nomeMun, layer });
          } else {
            const dist = levenshtein(termo, nomeLower);
            if (dist <= 3) {
              resultados.push({ nome: nomeMun, layer });
            }
          }
        }
      });

      if (resultados.length === 0) {
        listaMunicipios.style.display = 'none';
        return;
      }

      resultados.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item.nome;
        div.addEventListener('click', () => {
          map.fitBounds(item.layer.getBounds());
          item.layer.openPopup();
          listaMunicipios.style.display = 'none';
          searchInput.value = item.nome;
        });
        listaMunicipios.appendChild(div);
      });

      listaMunicipios.style.display = 'block';
    });

    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !listaMunicipios.contains(e.target)) {
        listaMunicipios.style.display = 'none';
      }
    });

    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const termo = this.value.trim().toLowerCase();
        if (!termo) return;

        let achou = false;
        municipiosLayer.eachLayer(layer => {
          const nomeMun = layer.feature.properties.NM_MUN;
          if (nomeMun && nomeMun.toLowerCase() === termo) {
            map.fitBounds(layer.getBounds());
            layer.openPopup();
            achou = true;
          }
        });
        if (!achou) alert('Município não encontrado!');
        listaMunicipios.style.display = 'none';
      }
    });

    const litigioLayer = new L.GeoJSON.AJAX("litigio.geojson", { 
      color: 'red', weight: 2, onEachFeature: onEachFeaturePopup
    });
    litigioLayer.addTo(map);

    const linhaImperialLayer = new L.GeoJSON.AJAX("linha_imperial.geojson", { 
      color: 'blue', weight: 2, dashArray: '5,5', onEachFeature: onEachFeaturePopup
    });
    linhaImperialLayer.addTo(map);

    litigioLayer.on('data:loaded', () => { litigioLayer.bringToFront(); });
    linhaImperialLayer.on('data:loaded', () => { litigioLayer.bringToFront(); });

    /* ==============================
       CONTROLE DE CAMADAS INICIAL (SERÁ SUBSTITUÍDO NO FINAL PELO NOVO)
       ============================== */
    /*
    const baseMaps = {
      "OpenStreetMap": osmLayer,
      "Esri Satélite": esriSat,
      "Esri Terrain": esriTerrain,
      "Esri Road": esriRoad
    }; 
    const overlayMaps = {
      "Territórios": territoriosLayer,
      "Municípios": municipiosLayer,
      "Litígio": litigioLayer,
      "Linha Imperial": linhaImperialLayer
    };
    const layersControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
    */

    // Defina baseMaps (não mexa)
    const baseMaps = {
      "OpenStreetMap": osmLayer,
      "Esri Satélite": esriSat,
      "Esri Terrain": esriTerrain,
      "Esri Road": esriRoad
    };

    // *** NOVO CONTROLE DE CAMADAS, INCLUINDO CAMADAS UPLOADADAS, E SUBSTITUINDO O CONTROLE ORIGINAL ***
    let layersControl = L.control.layers(baseMaps, {
      "Territórios": territoriosLayer,
      "Municípios": municipiosLayer,
      "Litígio": litigioLayer,
      "Linha Imperial": linhaImperialLayer
    }).addTo(map);

    // OBJETO PARA GUARDAR CAMADAS UPLOADADAS
    const layersUploadadas = {};

    // FUNÇÃO PARA ATUALIZAR O CONTROLE DE CAMADAS COM AS UPLOADADAS
    function atualizarControleCamadas() {
      layersControl.remove();
      const overlaysAtualizados = {
        "Territórios": territoriosLayer,
        "Municípios": municipiosLayer,
        "Litígio": litigioLayer,
        "Linha Imperial": linhaImperialLayer,
        ...layersUploadadas
      };
      layersControl = L.control.layers(baseMaps, overlaysAtualizados).addTo(map);
    }

    // FUNÇÃO PARA ADICIONAR KML AO MAPA E CONTROLAR ZOOM
    function addKMLToMap(kmlText, nomeArquivo) {
      const parser = new DOMParser();
      const kml = parser.parseFromString(kmlText, 'text/xml');
      const geojson = toGeoJSON.kml(kml);

      const novaLayer = L.geoJSON(geojson, {
        onEachFeature: onEachFeaturePopup
      }).addTo(map);

      layersUploadadas[nomeArquivo] = novaLayer;

      atualizarControleCamadas();

      map.fitBounds(novaLayer.getBounds());
    }

    // EVENTO DO INPUT DE UPLOAD, LENDO MULTIPLOS KML E KMZ
    document.getElementById('uploadInput').addEventListener('change', (e) => {
      const files = e.target.files;
      if (!files.length) return;

      [...files].forEach(file => {
        const reader = new FileReader();

        if (file.name.toLowerCase().endsWith('.kmz')) {
          reader.onload = function(evt) {
            JSZip.loadAsync(evt.target.result).then(zip => {
              const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
              if (kmlFile) {
                zip.files[kmlFile].async('text').then(kmlText => {
                  addKMLToMap(kmlText, file.name);
                });
              } else {
                alert('Arquivo KMZ não contém um KML válido!');
              }
            });
          };
          reader.readAsArrayBuffer(file);
        } else {
          reader.onload = function(evt) {
            addKMLToMap(evt.target.result, file.name);
          };
          reader.readAsText(file);
        }
      });
    });

    // BOTÃO PARA ABRIR DIALOGO DE UPLOAD
    document.getElementById('uploadBtn').addEventListener('click', () => {
      document.getElementById('uploadInput').click();
    });

    /* ========================
       MOSTRAR COORDENADAS NO MAPA
       ======================== */
    const coordsDiv = document.getElementById('coords');

    map.on('mousemove', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lon = e.latlng.lng.toFixed(6);
      const utm = proj4('EPSG:4326', 'EPSG:32723', [lon, lat]); // Exemplo UTM - você pode ajustar fuso/datum

      coordsDiv.innerHTML = `
        Lat: ${lat}°, Lon: ${lon}°<br>
        E: ${utm[0].toFixed(2)}, N: ${utm[1].toFixed(2)}<br>
        Fuso: 23S (exemplo)
      `;
    });

  </script>
</body>
</html>
