<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa – PIAUÍ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .legend {
      background: white;
      line-height: 18px;
      color: #333;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    #downloadBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }
    #uploadBtn {
      position: absolute;
      top: 80px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }
    #uploadInput { display: none; }
    .north-arrow {
      pointer-events: none;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Map_symbol_north_arrow.svg/64px-Map_symbol_north_arrow.svg.png');
      background-size: contain;
      background-repeat: no-repeat;
      width: 40px;
      height: 40px;
      opacity: 0.8;
      margin-right: 10px;
      margin-top: 10px;
    }
    #searchMunicipio {
      position: absolute;
      top: 30px;
      left: 1000px;
      z-index: 3000;
      padding: 5px 20px;
      width: 180px;
      border: 1px solid #ccc;
      border-radius: 40px;
      font-size: 20px;
    }
    #listaMunicipios {
      position: absolute;
      top: 70px;
      left: 1000px;
      z-index: 4000;
      max-height: 200px;
      overflow-y: auto;
      width: 180px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
      font-size: 16px;
    }
    #listaMunicipios div {
      padding: 4px 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #listaMunicipios div:hover { background-color: #ddd; }

    /* NOVO: Controle de coordenadas */
    #coords {
      position: absolute;
      bottom: 30px; /* acima da escala */
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="coords">Lat: - , Lon: - <br> UTM: - , Fuso: - </div> <!-- NOVO -->

  <button id="uploadBtn">Upload KML</button>
  <input type="file" id="uploadInput" accept=".kml,.kmz,.xml" multiple />
  
  <input type="text" id="searchMunicipio" placeholder="Pesquisar município" />
  <div id="listaMunicipios"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const map = L.map('map').setView([-7, -42], 7);
    L.control.scale().addTo(map);

    const north = L.control({position: "topright"});
    north.onAdd = function(map) {
      const div = L.DomUtil.create("div", "north-arrow");
      return div;
    };
    north.addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    /* NOVO: Atualiza coordenadas no movimento do mouse */
    const coordsDiv = document.getElementById('coords');
    map.on('mousemove', function (e) {
      const lat = e.latlng.lat.toFixed(5);
      const lon = e.latlng.lng.toFixed(5);
      const utm = latLonToUTM(e.latlng.lat, e.latlng.lng);
      coordsDiv.innerHTML = `Lat: ${lat}, Lon: ${lon}<br>UTM: ${utm.easting}, ${utm.northing} <br>Fuso: ${utm.zone}`;
    });

    /* NOVO: Função para converter Lat/Lon -> UTM */
    function latLonToUTM(lat, lon) {
      const a = 6378137.0; 
      const f = 1 / 298.257223563;
      const k0 = 0.9996;

      const zone = Math.floor((lon + 180) / 6) + 1;
      const λ0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;

      const φ = lat * Math.PI / 180;
      const λ = lon * Math.PI / 180;

      const e = Math.sqrt(f * (2 - f));
      const N = a / Math.sqrt(1 - e * e * Math.sin(φ) * Math.sin(φ));
      const T = Math.tan(φ) * Math.tan(φ);
      const C = (e * e / (1 - e * e)) * Math.cos(φ) * Math.cos(φ);
      const A = Math.cos(φ) * (λ - λ0);

      const M = a * (
        (1 - e * e / 4 - 3 * e ** 4 / 64 - 5 * e ** 6 / 256) * φ
        - (3 * e * e / 8 + 3 * e ** 4 / 32 + 45 * e ** 6 / 1024) * Math.sin(2 * φ)
        + (15 * e ** 4 / 256 + 45 * e ** 6 / 1024) * Math.sin(4 * φ)
        - (35 * e ** 6 / 3072) * Math.sin(6 * φ)
      );

      const easting = k0 * N * (A + (1 - T + C) * Math.pow(A, 3) / 6 + 
                      (5 - 18 * T + T * T + 72 * C - 58 * (e * e / (1 - e * e))) * Math.pow(A, 5) / 120) + 500000;

      const northing = k0 * (M + N * Math.tan(φ) * (A * A / 2 + 
                        (5 - T + 9 * C + 4 * C * C) * Math.pow(A, 4) / 24 +
                        (61 - 58 * T + T * T + 600 * C - 330 * (e * e / (1 - e * e))) * Math.pow(A, 6) / 720));

      return {
        easting: easting.toFixed(2),
        northing: northing.toFixed(2),
        zone
      };
    }

    // ---- RESTO DO SEU CÓDIGO (inalterado) ----
    const territorioPalette = [
      '#1f78b4', '#e31a1c', '#33a02c', '#ff7f00',
      '#6a3d9a', '#b15928', '#a6cee3', '#b2df8a',
      '#fb9a99', '#fdbf6f'
    ];

    const territorioColors = [];
    let colorIndex = 0;

    function getColorForTerritorio(nome) {
      let terr = territorioColors.find(t => t.nome === nome);
      if (!terr) {
        terr = { nome, cor: territorioPalette[colorIndex % territorioPalette.length] };
        territorioColors.push(terr);
        colorIndex++;
      }
      return terr.cor;
    }

    // ... (o restante do script continua igual)
  </script>
</body>
</html>
