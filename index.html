<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa – Sidebar e Download KML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .legend {
      background: white;
      line-height: 18px;
      color: #333;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    #downloadBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }
    #uploadBtn {
      position: absolute;
      top: 80px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }
    #uploadInput { display: none; }
    .north-arrow {
      pointer-events: none;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Map_symbol_north_arrow.svg/64px-Map_symbol_north_arrow.svg.png');
      background-size: contain;
      background-repeat: no-repeat;
      width: 40px;
      height: 40px;
      opacity: 0.8;
      margin-right: 10px;
      margin-top: 10px;
    }
    #searchMunicipio {
      position: absolute;
      top: 30px;
      left: 1000px;
      z-index: 3000;
      padding: 5px 20px;
      width: 180px;
      border: 1px solid #ccc;
      border-radius: 40px;
      font-size: 20px;
    }
    #listaMunicipios {
      position: absolute;
      top: 70px;
      left: 1000px;
      z-index: 4000;
      max-height: 200px;
      overflow-y: auto;
      width: 180px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
      font-size: 16px;
    }
    #listaMunicipios div {
      padding: 4px 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #listaMunicipios div:hover { background-color: #ddd; }
    #coords {
      position: absolute;
      bottom: 50px; /* subiu para não ficar na mesma altura da escala */
      left: 10px;
      background: rgba(255, 255, 255, 0.5); /* fundo branco semi-transparente */
      padding: 5px 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid rgba(204, 204, 204, 0.5);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="coords">
    Lat: -, Lon: -<br>
    E: -, N: -<br>
    Fuso: -<br>
    <small>Sistema: WGS84 (EPSG:4326), Datum: WGS84</small>
  </div>

  <button id="uploadBtn">Upload KML</button>
  <input type="file" id="uploadInput" accept=".kml,.kmz,.xml" multiple />
  
  <input type="text" id="searchMunicipio" placeholder="Pesquisar município" />
  <div id="listaMunicipios"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  
  <!-- Plugin Leaflet.Graticule para grades coordenadas -->
  <script src="https://unpkg.com/leaflet-graticule@1.0.0/dist/leaflet-graticule.min.js"></script>

  <script>
    const map = L.map('map').setView([-7, -42], 7);
    L.control.scale().addTo(map);

    const north = L.control({position: "topright"});
    north.onAdd = function(map) {
      const div = L.DomUtil.create("div", "north-arrow");
      return div;
    };
    north.addTo(map);

    // Base layers ESRI (adicionando para poder usar no controle depois)
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    const esriTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    const esriRoad = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    // Seu código para territoriosLayer, municipiosLayer, litigioLayer, linhaImperialLayer
    // ... (mantido exatamente como estava)

    // Exemplo (você deve substituir pelas suas layers e código original):
    const territoriosLayer = new L.GeoJSON.AJAX("territorios.geojson", { 
      style: styleTerritorios,
      onEachFeature: onEachFeaturePopup
    });
    territoriosLayer.addTo(map);

    const municipiosLayer = new L.GeoJSON.AJAX("municipios.geojson", { 
      style: styleMunicipios,
      onEachFeature: onEachMunicipio
    });
    municipiosLayer.addTo(map);

    const litigioLayer = new L.GeoJSON.AJAX("litigio.geojson", { 
      color: 'red', weight: 2, onEachFeature: onEachFeaturePopup
    });
    litigioLayer.addTo(map);

    const linhaImperialLayer = new L.GeoJSON.AJAX("linha_imperial.geojson", { 
      color: 'blue', weight: 2, dashArray: '5,5', onEachFeature: onEachFeaturePopup
    });
    linhaImperialLayer.addTo(map);

    // Grade coordenadas (graticule)
    const graticule = L.graticule({
      interval: 1,
      style: {
        color: '#777',
        weight: 1,
        opacity: 0.5,
        clickable: false
      },
      showOriginLabel: true,
      redraw: 'move'
    });

    // Controle de camadas com baseMaps e overlayMaps, incluindo a grade
    const baseMaps = {
      "OpenStreetMap": osmLayer,
      "Esri Satélite": esriSat,
      "Esri Terrain": esriTerrain,
      "Esri Road": esriRoad
    };

    const overlayMaps = {
      "Territórios": territoriosLayer,
      "Municípios": municipiosLayer,
      "Litígio": litigioLayer,
      "Linha Imperial": linhaImperialLayer,
      "Grade Coordenadas": graticule
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // Atualiza coordenadas no mousemove, mantendo o sistema/datum fixos
    const coordsDiv = document.getElementById('coords');
    map.on('mousemove', function (e) {
      const lat = e.latlng.lat.toFixed(5);
      const lon = e.latlng.lng.toFixed(5);
      const utm = latLonToUTM(e.latlng.lat, e.latlng.lng);
      coordsDiv.innerHTML = 
        `Lat: ${lat}, Lon: ${lon}<br>` +
        `E: ${utm.x.toFixed(2)}, N: ${utm.y.toFixed(2)}<br>` +
        `Fuso: ${utm.zone}<br>` +
        `<small>Sistema: WGS84 (EPSG:4326), Datum: WGS84</small>`;
    });

    // Função latLonToUTM mantida exatamente igual (copie do seu código)
    function latLonToUTM(lat, lon) {
      const a = 6378137.0;
      const f = 1 / 298.257223563;
      const k0 = 0.9996;
      const e = Math.sqrt(f * (2 - f));

      const zone = Math.floor((lon + 180) / 6) + 1;
      const λ0 = (zone - 1) * 6 - 180 + 3;
      const λ0rad = λ0 * Math.PI / 180;

      const φ = lat * Math.PI / 180;
      const λ = lon * Math.PI / 180;

      const N = a / Math.sqrt(1 - e * e * Math.sin(φ) * Math.sin(φ));
      const T = Math.tan(φ) * Math.tan(φ);
      const C = (e * e / (1 - e * e)) * Math.cos(φ) * Math.cos(φ);
      const A = Math.cos(φ) * (λ - λ0rad);

      const M = a * (
        (1 - e * e / 4 - 3 * e ** 4 / 64 - 5 * e ** 6 / 256) * φ
        - (3 * e * e / 8 + 3 * e ** 4 / 32 + 45 * e ** 6 / 1024) * Math.sin(2 * φ)
        + (15 * e ** 4 / 256 + 45 * e ** 6 / 1024) * Math.sin(4 * φ)
        - (35 * e ** 6 / 3072) * Math.sin(6 * φ)
      );

      const x = k0 * N * (A + (1 - T + C) * A ** 3 / 6
        + (5 - 18 * T + T * T + 72 * C - 58 * (e * e / (1 - e * e))) * A ** 5 / 120) + 500000.0;

      let y = k0 * (M + N * Math.tan(φ) * (A ** 2 / 2 + (5 - T + 9 * C + 4 * C ** 2) * A ** 4 / 24
        + (61 - 58 * T + T * T + 600 * C - 330 * (e * e / (1 - e * e))) * A ** 6 / 720));

      if (lat < 0) y += 10000000.0;

      return { x, y, zone };
    }

    // ... (o restante do seu código permanece inalterado)

  </script>
</body>
</html>
